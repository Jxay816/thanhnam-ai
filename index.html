<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KunAI - Premium Interface</title>
    <style>
        :root { --primary: #007aff; --accent: #5856d6; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 480px; background: var(--card); display: flex; flex-direction: column; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        
        /* Header */
        .header { padding: 20px; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h2 { margin: 0; font-size: 22px; background: linear-gradient(90deg, #007aff, #5856d6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .btn-out { font-size: 12px; padding: 6px 12px; border: 1px solid #ef4444; color: #ef4444; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .btn-out:hover { background: #ef4444; color: white; }

        /* Auth Part */
        #auth-part { padding: 40px 30px; flex: 1; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .logo-main { font-size: 50px; margin-bottom: 10px; font-weight: 900; letter-spacing: -2px; }
        input { background: #334155; border: 1px solid #475569; padding: 15px; border-radius: 12px; color: white; margin-bottom: 15px; font-size: 16px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0,122,255,0.2); }
        button.primary-btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        .sub-link { color: #94a3b8; margin-top: 20px; cursor: pointer; font-size: 14px; }

        /* Chat Part */
        #chat-part { display: none; flex-direction: column; flex: 1; overflow: hidden; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; line-height: 1.5; font-size: 15px; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .u { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .b { align-self: flex-start; background: #334155; color: white; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }

        /* Plus UI */
        .plus-status { padding: 10px; background: rgba(245, 158, 11, 0.1); border-top: 1px solid rgba(245, 158, 11, 0.2); text-align: center; font-size: 12px; }
        .btn-plus { color: #f59e0b; font-weight: 800; text-decoration: underline; cursor: pointer; margin-left: 5px; }

        /* Input Area */
        .input-group { padding: 20px; background: var(--card); border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; }
        .input-group input { flex: 1; margin: 0; background: #0f172a; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 99; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card); width: 85%; max-width: 350px; padding: 30px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .bill-card { background: #0f172a; padding: 20px; border-radius: 16px; margin: 20px 0; border: 1px dashed var(--primary); text-align: left; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="auth-part">
        <div class="logo-main">KunAI</div>
        <p style="color:#94a3b8; margin-bottom: 30px;">Intelligence Experience</p>
        <input type="text" id="user" placeholder="Username">
        <input type="password" id="pass" placeholder="Password">
        <button class="primary-btn" onclick="handleAuth('login')">LOGIN</button>
        <div class="sub-link" onclick="handleAuth('reg')">Tạo tài khoản mới (Giới hạn 3 acc/IP)</div>
    </div>

    <div id="chat-part">
        <div class="header">
            <h2 id="header-name">KunAI</h2>
            <div class="btn-out" onclick="location.reload()">LOGOUT</div>
        </div>
        <div id="chat-box"></div>
        <div class="plus-status">
            <span id="limit-txt">Gói Miễn Phí: 0/10</span> | 
            <span class="btn-plus" onclick="openPlus()">NÂNG CẤP PLUS ✨</span>
        </div>
        <div class="input-group">
            <input type="text" id="msg-input" placeholder="Hỏi gì đó..." onkeypress="if(event.key==='Enter') askAI()">
            <button class="primary-btn" style="padding: 0 20px;" onclick="askAI()">GỬI</button>
        </div>
    </div>
</div>

<div id="plus-modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 style="margin:0;">Nâng Cấp PLUS</h2>
        <div class="bill-card">
            <p style="margin:0; color:#94a3b8; font-size:12px;">ZALO PAY</p>
            <p style="margin:5px 0; font-weight:bold; font-size:18px;">0965658978</p>
            <p style="margin:10px 0 0 0; color:#94a3b8; font-size:12px;">NỘI DUNG CK:</p>
            <p id="bill-code" style="margin:5px 0; color:#007aff; font-weight:bold;"></p>
        </div>
        <p style="color:#ef4444; font-size:13px; font-weight:bold; line-height:1.4;">
            LƯU Ý: Phải chụp bill + nội dung ck gửi qua Zalo: 0586953515 để được Admin Thanh Nam duyệt Plus.
        </p>
        <button class="primary-btn" style="width:100%; margin-top:10px; background:#475569;" onclick="document.getElementById('plus-modal').style.display='none'">ĐÓNG</button>
    </div>
</div>

<script>
    const DB = "https://c2-premium-default-rtdb.firebaseio.com/";
    const KEY = "AIzaSyD5ndz8VHowBFoeh0kslesF5uLmLq1WrkE";
    let curU = "", userIP = "", isPlus = false;

    async function init() {
        try {
            const res = await fetch('https://api.ipify.org?format=json');
            const d = await res.json();
            userIP = d.ip.replace(/\./g, '_');
            const ban = await fetch(`${DB}/BannedIPs/${userIP}.json`);
            if (await ban.json()) document.body.innerHTML = "<div style='padding:50px; text-align:center;'><h2>IP BỊ KHÓA</h2></div>";
        } catch(e) {}
    }

    async function handleAuth(type) {
        const u = document.getElementById('user').value.trim().toLowerCase();
        const p = document.getElementById('pass').value.trim();
        if(!u || !p) return alert("Nhập đủ thông tin!");

        if(type === 'reg') {
            const ipRes = await fetch(`${DB}/UsedIPs/${userIP}/count.json`);
            let count = await ipRes.json() || 0;
            if(count >= 3) {
                alert("IP này đã tạo 3 acc! CẤM IP!");
                await fetch(`${DB}/BannedIPs/${userIP}.json`, {method:'PUT', body:'true'});
                return location.reload();
            }
            const check = await fetch(`${DB}/accounts/${u}.json`);
            if(await check.json()) return alert("Tên đã tồn tại!");
            await fetch(`${DB}/accounts/${u}.json`, {method:'PUT', body: JSON.stringify({pass:p, isPlus:false, msgCount:0})});
            await fetch(`${DB}/UsedIPs/${userIP}/count.json`, {method:'PUT', body: JSON.stringify(count+1)});
            alert("Đăng ký xong!");
        } else {
            const res = await fetch(`${DB}/accounts/${u}.json`);
            const data = await res.json();
            if(!data || data.pass !== p) return alert("Sai tài khoản!");
            curU = u; isPlus = data.isPlus;
            document.getElementById('auth-part').style.display = 'none';
            document.getElementById('chat-part').style.display = 'flex';
            document.getElementById('header-name').innerText = u.toUpperCase();
            updateStatus(data.msgCount);
        }
    }

    function updateStatus(count) {
        document.getElementById('limit-txt').innerText = isPlus ? "Gói: PLUS (Vô Hạn)" : `Free: ${count}/10 tin`;
    }

    async function askAI() {
        const resAcc = await fetch(`${DB}/accounts/${curU}.json`);
        const acc = await resAcc.json();
        if(!acc.isPlus && acc.msgCount >= 10) return alert("Hết lượt! Nạp Plus đi.");

        const inp = document.getElementById('msg-input');
        const txt = inp.value.trim();
        if(!txt) return;

        const box = document.getElementById('chat-box');
        box.innerHTML += `<div class="msg u">${txt}</div>`;
        inp.value = ""; box.scrollTop = box.scrollHeight;

        try {
            const apiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: txt }] }] })
            });
            const d = await apiRes.json();
            let ans = (d.candidates && d.candidates[0].content) ? d.candidates[0].content.parts[0].text : "AI đang bận, thử lại sau!";
            box.innerHTML += `<div class="msg b">${ans}</div>`;
            
            if(!isPlus) {
                const newCount = (acc.msgCount || 0) + 1;
                await fetch(`${DB}/accounts/${curU}/msgCount.json`, {method:'PUT', body: JSON.stringify(newCount)});
                updateStatus(newCount);
            }
            box.scrollTop = box.scrollHeight;
        } catch(e) { box.innerHTML += `<div class="msg b">Lỗi kết nối AI!</div>`; }
    }

    function openPlus() {
        document.getElementById('bill-code').innerText = "KUNAI " + curU.toUpperCase() + " " + Math.floor(1000+Math.random()*9000);
        document.getElementById('plus-modal').style.display = 'flex';
    }
    init();
</script>
</body>
    </html>
    
