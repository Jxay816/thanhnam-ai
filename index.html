<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Truyá»‡n - ÄÄƒng nháº­p</title>
  <style>
    body{font-family:system-ui,Arial;margin:20px;max-width:720px}
    input,button{padding:10px;margin:6px 0;width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid #ddd;border-radius:10px;padding:14px;margin-top:14px}
    .hidden{display:none}
  </style>
</head>
<body>
  <h2>ğŸ“š Web Truyá»‡n (Demo)</h2>

  <div class="card">
    <h3>ÄÄƒng kÃ½</h3>
    <input id="su_email" placeholder="Email (vd: a@gmail.com)" />
    <input id="su_pass" placeholder="Máº­t kháº©u" type="password" />
    <button onclick="signUp()">Táº¡o tÃ i khoáº£n</button>
    <div id="su_msg"></div>
  </div>

  <div class="card">
    <h3>ÄÄƒng nháº­p</h3>
    <input id="li_email" placeholder="Email" />
    <input id="li_pass" placeholder="Máº­t kháº©u" type="password" />
    <button onclick="login()">ÄÄƒng nháº­p</button>
    <div id="li_msg"></div>
  </div>

  <div id="app" class="card hidden">
    <h3>âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng</h3>
    <p id="hello"></p>
    <p>PRO: <b id="proFlag"></b></p>
    <button onclick="logout()">ÄÄƒng xuáº¥t</button>
  </div>

<script>
  const DB = "https://c2-premium-default-rtdb.firebaseio.com";

  // biáº¿n email thÃ nh key an toÃ n cho Firebase path
  function userKeyFromEmail(email){
    return email.trim().toLowerCase()
      .replaceAll('.', '_')
      .replaceAll('@', '_at_')
      .replaceAll('#','_')
      .replaceAll('$','_')
      .replaceAll('[','_')
      .replaceAll(']','_')
      .replaceAll('/','_');
  }

  async function sha256(text){
    const enc = new TextEncoder().encode(text);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function dbGet(path){
    const r = await fetch(`${DB}/${path}.json`);
    return await r.json();
  }
  async function dbPut(path, data){
    const r = await fetch(`${DB}/${path}.json`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(data)
    });
    return await r.json();
  }

  async function signUp(){
    const email = document.getElementById("su_email").value;
    const pass  = document.getElementById("su_pass").value;
    const msg   = document.getElementById("su_msg");
    msg.textContent = "";

    if(!email || !pass) return msg.textContent = "âŒ Nháº­p Ä‘á»§ email + máº­t kháº©u";

    const key = userKeyFromEmail(email);
    const exists = await dbGet(`users/${key}`);
    if(exists) return msg.textContent = "âŒ TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i";

    const passHash = await sha256(pass);

    // âœ… DÃ’NG NÃ€Y sáº½ tá»± táº¡o node /users náº¿u chÆ°a cÃ³
    await dbPut(`users/${key}`, {
      email,
      passHash,
      pro: false,
      isAdmin: false,
      createdAt: Date.now()
    });

    msg.textContent = "âœ… ÄÄƒng kÃ½ xong! Giá» Ä‘Äƒng nháº­p thá»­ Ä‘i.";
  }

  async function login(){
    const email = document.getElementById("li_email").value;
    const pass  = document.getElementById("li_pass").value;
    const msg   = document.getElementById("li_msg");
    msg.textContent = "";

    if(!email || !pass) return msg.textContent = "âŒ Nháº­p Ä‘á»§ email + máº­t kháº©u";

    const key = userKeyFromEmail(email);
    const u = await dbGet(`users/${key}`);
    if(!u) return msg.textContent = "âŒ KhÃ´ng cÃ³ tÃ i khoáº£n";

    const passHash = await sha256(pass);
    if(u.passHash !== passHash) return msg.textContent = "âŒ Sai máº­t kháº©u";

    localStorage.setItem("userKey", key);
    renderApp(u);
    msg.textContent = "âœ… OK!";
  }

  function logout(){
    localStorage.removeItem("userKey");
    document.getElementById("app").classList.add("hidden");
  }

  function renderApp(u){
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("hello").textContent = `Xin chÃ o: ${u.email}`;
    document.getElementById("proFlag").textContent = u.pro ? "âœ… CÃ³" : "âŒ ChÆ°a";
  }

  // auto load session
  (async function(){
    const key = localStorage.getItem("userKey");
    if(!key) return;
    const u = await dbGet(`users/${key}`);
    if(u) renderApp(u);
  })();
</script>
</body>
</html>